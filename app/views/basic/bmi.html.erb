<h1 class="center">Height and weight</h1>

<table id="instructions" class="two-col" style="width: 50%; margin: 6rem auto 0 auto;">
  <tr>
    <td style="text-align: center;vertical-align: middle;">
      <%= image_tag "stand_up_straight.svg", style: "height: 350px;" %>
    </td>
    <td style="vertical-align: middle;">
      <ol style="font-size: 2rem; line-height: 5rem;">
        <li>Stand on the scales</li>
        <li>Stand up straight</li>
        <li>Listen for a "beep"</li>
      </ol>
    </td>
  </tr>
</table>

<table id="results" class="two-col" style="width: 50%; margin: 6rem auto 0 auto;display: none;">
  <tr>
    <td style="text-align: center;vertical-align: middle;font-size: 2rem;">
      Your weight
      <div id="weight"></div>
    </td>
    <td style="text-align: center;vertical-align: middle;font-size: 2rem;">
      Your height
      <div id="height"></div>
    </td>
  </tr>
</table>

<div id="retry-bmi-model-content" style="display: none;">
  <h1 class="center">Try measuring your<br/>height and weight again?</h1>
  <div style="text-align: center;margin: 3rem auto 4rem auto;">
    <p>There was a problem with measuring your height and weight.</p>
    <p>Would you like to try again?</p>
  </div>

  <table class="two-col" style="width: 30rem;">
    <tr>
      <td><button type="button" class="btn btn-primary" onclick="retryReadBmiData();return false;">Retry</button></td>
      <td style="text-align: right;"><button type="button" class="btn btn-secondary" onclick="gotoNext();return false;">Cancel</button></td>
    </tr>
  </table>
</div>
<%= render :partial => 'partials/modal' %>

<% content_for :footer_left do %>
  <%= render :partial => 'partials/exit_modal', locals: { exit_url: root_url } %>
<% end %>
<% content_for :footer_center do %>
  <%= progress_bar %>
<% end %>
<% content_for :footer_right do %>
  <%= next_button nil, has_diabetes_url, "Next" %>
<% end %>

<script>

var retryDialogContent;
var retryCount = 0;
var MAX_BMI_READ_RETRIES = <%= Rails.configuration.x.max_bmi_scale_retries %>
var ajax_url = '<%= bmi_read_url %>';
var next_url = '<%= has_diabetes_url %>';

$(document).ready(function() {
  retryDialogContent = $("#retry-bmi-model-content").detach();
  readBmiData();
});

function readBmiData() {
  $.ajax({
    url: ajax_url,
    success: function (data) {
        $('#instructions').hide();
        $('#weight').text(data.weight + ' kg');
        $('#height').text(data.height + ' cm');
        $('#results').show();
        $('#next').removeClass('disabled').attr('href', next_url);
    },
    error: function () {
      if (retryCount < MAX_BMI_READ_RETRIES) {
        showModal(retryDialogContent);
      } else {
        gotoNext();
      }
    }
  });
}

function retryReadBmiData() {
  retryCount++;
  resetSession();
  hideModal();
  readBmiData();
}

function gotoNext() {
  window.location = next_url;
}

</script>

<%= render :partial => 'partials/timeout_modal' %>
